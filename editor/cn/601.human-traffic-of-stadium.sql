-- è¡¨ï¼šStadium
--  
--  
--  
-- +---------------+---------+
-- | Column Name   | Type    |
-- +---------------+---------+
-- | id            | int     |
-- | visit_date    | date    |
-- | people        | int     |
-- +---------------+---------+
-- visit_date æ˜¯è¡¨çš„ä¸»é”®
-- æ¯æ—¥äººæµé‡ä¿¡æ¯è¢«è®°å½•åœ¨è¿™ä¸‰åˆ—ä¿¡æ¯ä¸­ï¼šåºå· (id)ã€æ—¥æœŸ (visit_date)ã€Â äººæµé‡ (people)
-- æ¯å¤©åªæœ‰ä¸€è¡Œè®°å½•ï¼Œæ—¥æœŸéšç€ id çš„å¢žåŠ è€Œå¢žåŠ 
--  
-- 
--  
-- 
--  ç¼–å†™ä¸€ä¸ª SQL æŸ¥è¯¢ä»¥æ‰¾å‡ºæ¯è¡Œçš„äººæ•°å¤§äºŽæˆ–ç­‰äºŽ 100 ä¸” id è¿žç»­çš„ä¸‰è¡Œæˆ–æ›´å¤šè¡Œè®°å½•ã€‚ 
-- 
--  è¿”å›žæŒ‰ visit_date å‡åºæŽ’åˆ—çš„ç»“æžœè¡¨ã€‚ 
-- 
--  æŸ¥è¯¢ç»“æžœæ ¼å¼å¦‚ä¸‹æ‰€ç¤ºã€‚ 
-- 
--  
-- Stadium table:
-- +------+------------+-----------+
-- | id   | visit_date | people    |
-- +------+------------+-----------+
-- | 1    | 2017-01-01 | 10        |
-- | 2    | 2017-01-02 | 109       |
-- | 3    | 2017-01-03 | 150       |
-- | 4    | 2017-01-04 | 99        |
-- | 5    | 2017-01-05 | 145       |
-- | 6    | 2017-01-06 | 1455      |
-- | 7    | 2017-01-07 | 199       |
-- | 8    | 2017-01-09 | 188       |
-- +------+------------+-----------+
-- 
-- Result table:
-- +------+------------+-----------+
-- | id   | visit_date | people    |
-- +------+------------+-----------+
-- | 5    | 2017-01-05 | 145       |
-- | 6    | 2017-01-06 | 1455      |
-- | 7    | 2017-01-07 | 199       |
-- | 8    | 2017-01-09 | 188       |
-- +------+------------+-----------+
-- id ä¸º 5ã€6ã€7ã€8 çš„å››è¡Œ id è¿žç»­ï¼Œå¹¶ä¸”æ¯è¡Œéƒ½æœ‰ >= 100 çš„äººæ•°è®°å½•ã€‚
-- è¯·æ³¨æ„ï¼Œå³ä½¿ç¬¬ 7 è¡Œå’Œç¬¬ 8 è¡Œçš„ visit_date ä¸æ˜¯è¿žç»­çš„ï¼Œè¾“å‡ºä¹Ÿåº”å½“åŒ…å«ç¬¬ 8 è¡Œï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è¦è€ƒè™‘ id è¿žç»­çš„è®°å½•ã€‚
-- ä¸è¾“å‡º id ä¸º 2 å’Œ 3 çš„è¡Œï¼Œå› ä¸ºè‡³å°‘éœ€è¦ä¸‰æ¡ id è¿žç»­çš„è®°å½•ã€‚
--  
--  
--  
--  ðŸ‘ 160 ðŸ‘Ž 0

# é€‚åˆå¤§æ•°æ®æƒ…å†µä¸‹çš„è§£æ³•
SELECT p.id, p.visit_date, p.people
FROM (
 SELECT t.id, t.visit_date, t.people, COUNT(*) over(partition by t.id_group) 'continious_ids'
 FROM (
     # å…ˆå–å¤§äºŽç­‰äºŽ100çš„è®°å½•ï¼Œåœ¨çª—å£è®¡ç®—ä¸‹ï¼Œè¿žç»­çš„è®°å½• id - ROW_NUMBER çš„å€¼ä¸€å®šç›¸åŒ
     SELECT *, id - row_number() over(order by id) 'id_group' FROM Stadium WHERE people >= 100
 ) t
) p
# åˆ†ç»„æ±‚å’Œä¹‹åŽè¿‡æ»¤ >= 3 çš„ï¼Œåˆ™å‰©ä¸‹çš„è®°å½•ä¸€å®šæ˜¯è¿žç»­è¶…è¿‡3æ¡çš„
WHERE continious_ids >= 3
ORDER BY p.visit_date
;

# å¦ä¸€ç§å†™æ³•
with t1 as (
    select
        id,
        visit_date,
        people,
        # æ±‚å‡ºå·®å€¼ï¼Œå› ä¸ºidä¸€å®šä¸ä¼šç›¸åŒï¼Œæ‰€ä»¥ä½¿ç”¨æœ€ç†Ÿæ‚‰çš„rankå°±å¥½
        id-rank() over(order by id) rk
    from stadium
    where people >= 100
)
select
    id,
    visit_date,
    people
from t1
#whereæ¡ä»¶è¿‡æ»¤å‡ºæ¡æ•°å¤§äºŽ3çš„
where rk in (select rk from t1 group by rk having count(1) >= 3);
